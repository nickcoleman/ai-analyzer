{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Trade Instruction Schema v8.0.0",
  "description": "Comprehensive JSON schema for Trade Instructions generated by Portfolio Orchestrator v8.0.0-alpha",
  "type": "object",
  "required": [
    "meta",
    "trade",
    "reasoning",
    "validation"
  ],
  "properties": {
    "meta": {
      "type": "object",
      "description": "Metadata about the trade instruction generation",
      "required": [
        "portfolio_orchestrator_version",
        "timestamp",
        "execution_date"
      ],
      "properties": {
        "portfolio_orchestrator_version": {
          "type": "string",
          "description": "Version of Portfolio Orchestrator that generated this instruction",
          "pattern": "^v[0-9]+\\.[0-9]+\\.[0-9]+(-(alpha|beta|rc))?$",
          "example": "v8.0.0-alpha"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO8601 timestamp when instruction was generated",
          "example": "2025-12-08T14:30:00Z"
        },
        "execution_date": {
          "type": "string",
          "format": "date",
          "description": "Intended execution date (YYYY-MM-DD)",
          "example": "2025-12-08"
        },
        "batch_id": {
          "type": "string",
          "description": "Optional batch identifier if this is part of a batch",
          "example": "PO_20251208_001"
        },
        "instruction_id": {
          "type": "string",
          "description": "Unique identifier for this specific instruction",
          "example": "PO_20251208_001_AAPL"
        }
      }
    },
    "trade": {
      "type": "object",
      "description": "Core trade execution parameters",
      "required": [
        "symbol",
        "action",
        "quantity_pct",
        "order_type",
        "conviction_tier",
        "conviction_score"
      ],
      "properties": {
        "symbol": {
          "type": "string",
          "description": "Stock ticker symbol",
          "pattern": "^[A-Z]{1,5}$",
          "example": "AAPL"
        },
        "action": {
          "type": "string",
          "enum": [
            "BUY",
            "SELL",
            "HOLD",
            "BLOCKED"
          ],
          "description": "Recommended action"
        },
        "quantity_pct": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 0.5,
          "description": "Allocation as percentage of portfolio (0.0 to 0.5 = 0% to 50%)",
          "example": 0.025
        },
        "quantity_dollars": {
          "type": "number",
          "minimum": 0.0,
          "description": "Optional: calculated dollar amount based on portfolio value",
          "example": 12500.0
        },
        "target_price": {
          "type": "number",
          "minimum": 0.0,
          "description": "Target price from Stock Analyst conviction thesis",
          "example": 250.0
        },
        "current_price": {
          "type": "number",
          "minimum": 0.0,
          "description": "Current market price at time of generation",
          "example": 230.0
        },
        "upside_downside": {
          "type": "number",
          "description": "Percentage upside/downside from current to target",
          "example": 0.087
        },
        "order_type": {
          "type": "string",
          "enum": [
            "MARKET",
            "LIMIT",
            "STOP_LOSS",
            "TRAILING_STOP",
            "NONE"
          ],
          "description": "Recommended order execution type"
        },
        "limit_price": {
          "type": "number",
          "minimum": 0.0,
          "description": "Limit price if order_type is LIMIT or STOP_LOSS",
          "example": 228.0
        },
        "time_in_force": {
          "type": "string",
          "enum": [
            "DAY",
            "GTC",
            "IOC",
            "FOK",
            "NONE"
          ],
          "description": "Time in force for the order (Day / Good-Till-Cancelled / etc.)"
        },
        "conviction_tier": {
          "type": "string",
          "enum": [
            "HIGH",
            "MEDIUM-HIGH",
            "MEDIUM",
            "MEDIUM-LOW",
            "LOW"
          ],
          "description": "Conviction tier from Stock Analyst"
        },
        "conviction_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Numerical conviction score (0.0 to 1.0)"
        },
        "strategy_type": {
          "type": "string",
          "enum": [
            "GROWTH",
            "CONTRARIAN",
            "VALUE"
          ],
          "description": "Strategy classification from Stock Analyst"
        },
        "time_horizon": {
          "type": "string",
          "enum": [
            "3_MONTHS",
            "6_MONTHS",
            "12_MONTHS"
          ],
          "description": "Recommended holding period"
        }
      }
    },
    "reasoning": {
      "type": "object",
      "description": "Detailed reasoning for the trade instruction decision",
      "required": [
        "regime",
        "strategy",
        "base_allocation",
        "regime_multiplier",
        "final_allocation",
        "rationale"
      ],
      "properties": {
        "regime": {
          "type": "string",
          "enum": [
            "SUPPORTIVE",
            "NEUTRAL",
            "NEGATIVE",
            "HOSTILE"
          ],
          "description": "Market regime classification"
        },
        "risk_regime": {
          "type": "string",
          "enum": [
            "NORMAL",
            "ELEVATED",
            "HIGH",
            "CRISIS"
          ],
          "description": "Risk regime from Market Analyst"
        },
        "market_regime": {
          "type": "string",
          "enum": [
            "GROWTH",
            "VALUE",
            "DEFENSIVE",
            "TRANSITION"
          ],
          "description": "Market regime from Market Analyst"
        },
        "strategy": {
          "type": "string",
          "enum": [
            "GROWTH",
            "CONTRARIAN",
            "VALUE"
          ],
          "description": "Strategy type from Stock Analyst"
        },
        "base_allocation": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 0.5,
          "description": "Base allocation before regime and constraint adjustments",
          "example": 0.05
        },
        "risk_multiplier": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Risk regime multiplier (NORMAL=1.0x, ELEVATED=0.6x, HIGH=0.4x, CRISIS=0.2x)"
        },
        "regime_multiplier": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Additional regime-gate multiplier from decision tree"
        },
        "final_allocation": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 0.5,
          "description": "Final allocation after all adjustments and constraints"
        },
        "exception_applied": {
          "type": "boolean",
          "description": "Whether Contrarian Exception was applied (HOSTILE regime + CONTRARIAN strategy)"
        },
        "exception_type": {
          "type": "string",
          "enum": [
            "CONTRARIAN_EXCEPTION",
            "NONE"
          ],
          "description": "Type of exception applied if any"
        },
        "weighting_context": {
          "type": "string",
          "enum": [
            "BASELINE",
            "EVENT-DRIVEN",
            "MACRO-DRIVEN",
            "CRISIS",
            "TECHNICAL",
            "SENTIMENT",
            "MOMENTUM_FADE",
            "MACRO_SUBORD"
          ],
          "description": "Expert weighting context used by Stock Analyst"
        },
        "constraints_applied": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "MAX_POSITION_SIZE",
              "CASH_BUFFER_MINIMUM",
              "INSUFFICIENT_CASH",
              "PORTFOLIO_CONCENTRATION_LIMIT",
              "SECTOR_LIMIT",
              "NONE"
            ]
          },
          "description": "List of constraints that affected final allocation"
        },
        "rationale": {
          "type": "string",
          "minLength": 100,
          "description": "Detailed English explanation of the decision (minimum 100 characters)",
          "example": "CONTRARIAN EXCEPTION: 0.2% pilot deployment in hostile (CRISIS) market regime. HIGH conviction thesis (0.85) on technical grounds warrants controlled entry despite market headwinds. Limits portfolio risk via pilot sizing (20% of normal allocation)."
        },
        "deconflicting_notes": {
          "type": "string",
          "description": "Optional notes on expert consensus and any deconflicting that occurred",
          "example": "FMA (0.80 conf) and IRM (0.90 conf) aligned on fundamental strength. MSPA dispersed (0.65 conf). Applied baseline weighting (70% FMA, 15% IRM, 10% MSPA, 5% QMA)."
        }
      }
    },
    "validation": {
      "type": "object",
      "description": "Validation and compliance status",
      "required": [
        "qa_status",
        "all_constraints_met"
      ],
      "properties": {
        "qa_status": {
          "type": "string",
          "enum": [
            "PASS",
            "FAIL"
          ],
          "description": "QA compliance status"
        },
        "qa_issues": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of any QA validation issues",
          "example": [
            "Data freshness: MA_Output timestamp > 4 hours old",
            "Portfolio cash buffer will be violated"
          ]
        },
        "escalation_flag": {
          "type": "string",
          "enum": [
            "PASS",
            "ALERT"
          ],
          "description": "Whether escalation to Master Architect is required"
        },
        "escalation_reason": {
          "type": "string",
          "description": "Reason for escalation if flag is ALERT",
          "example": "Multiple simultaneous contrarian pilots would exceed 5% portfolio concentration"
        },
        "all_constraints_met": {
          "type": "boolean",
          "description": "Whether all portfolio constraints are satisfied post-trade"
        },
        "data_freshness": {
          "type": "object",
          "description": "Data freshness status for key inputs",
          "properties": {
            "sa_output_age_minutes": {
              "type": "number",
              "minimum": 0.0,
              "description": "Age of SA_Output in minutes"
            },
            "ma_output_age_minutes": {
              "type": "number",
              "minimum": 0.0,
              "description": "Age of MA_Output in minutes"
            },
            "portfolio_state_age_minutes": {
              "type": "number",
              "minimum": 0.0,
              "description": "Age of Portfolio_State in minutes"
            },
            "freshness_status": {
              "type": "string",
              "enum": [
                "FRESH",
                "STALE_WARNING",
                "STALE_CRITICAL"
              ],
              "description": "Overall freshness status"
            }
          }
        },
        "schema_validation": {
          "type": "object",
          "properties": {
            "sa_output_valid": {
              "type": "boolean",
              "description": "Whether SA_Output matches required schema"
            },
            "ma_output_valid": {
              "type": "boolean",
              "description": "Whether MA_Output matches required schema"
            },
            "all_required_fields_present": {
              "type": "boolean",
              "description": "Whether all required fields in Trade_Instruction are present"
            }
          }
        }
      }
    },
    "portfolio_impact": {
      "type": "object",
      "description": "Optional projected impact on portfolio state",
      "properties": {
        "cash_impact": {
          "type": "number",
          "description": "Dollar amount of cash impact (negative = outflow)",
          "example": -12500.0
        },
        "cash_remaining": {
          "type": "number",
          "description": "Projected cash balance after trade",
          "example": 37500.0
        },
        "new_position_size": {
          "type": "number",
          "description": "Projected new position value",
          "example": 12500.0
        },
        "portfolio_concentration_after": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Projected portfolio concentration (max single position as % of total)"
        },
        "estimated_var_change": {
          "type": "number",
          "description": "Estimated change in portfolio Value-at-Risk (optional)",
          "example": 0.005
        }
      }
    },
    "audit": {
      "type": "object",
      "description": "Audit trail for compliance and debugging",
      "properties": {
        "sa_output_hash": {
          "type": "string",
          "description": "SHA256 hash of input SA_Output for audit"
        },
        "ma_output_hash": {
          "type": "string",
          "description": "SHA256 hash of input MA_Output for audit"
        },
        "processing_steps": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "step_name": {
                "type": "string",
                "enum": [
                  "validate_inputs",
                  "classify_regime",
                  "apply_decision_tree",
                  "check_contrarian_exception",
                  "calculate_sizing",
                  "enforce_constraints",
                  "generate_order_type",
                  "build_rationale"
                ]
              },
              "result": {
                "type": "string",
                "enum": [
                  "PASS",
                  "FAIL",
                  "WARNING"
                ]
              },
              "details": {
                "type": "string"
              },
              "timestamp": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        }
      }
    }
  },
  "examples": [
    {
      "meta": {
        "portfolio_orchestrator_version": "v8.0.0-alpha",
        "timestamp": "2025-12-08T14:30:00Z",
        "execution_date": "2025-12-08",
        "batch_id": "PO_20251208_001",
        "instruction_id": "PO_20251208_001_AAPL"
      },
      "trade": {
        "symbol": "AAPL",
        "action": "BUY",
        "quantity_pct": 0.025,
        "quantity_dollars": 12500.0,
        "target_price": 250.0,
        "current_price": 230.0,
        "upside_downside": 0.087,
        "order_type": "LIMIT",
        "limit_price": 228.0,
        "time_in_force": "GTC",
        "conviction_tier": "HIGH",
        "conviction_score": 0.85,
        "strategy_type": "GROWTH",
        "time_horizon": "6_MONTHS"
      },
      "reasoning": {
        "regime": "SUPPORTIVE",
        "risk_regime": "NORMAL",
        "market_regime": "GROWTH",
        "strategy": "GROWTH",
        "base_allocation": 0.05,
        "risk_multiplier": 1.0,
        "regime_multiplier": 1.0,
        "final_allocation": 0.025,
        "exception_applied": false,
        "weighting_context": "BASELINE",
        "constraints_applied": [
          "MAX_POSITION_SIZE"
        ],
        "rationale": "HIGH conviction (0.85) GROWTH thesis in supportive market regime. Fundamental strength (FMA 0.80, IRM 0.90) warrants full allocation at baseline sizing. Position capped at 2.5% per max_position_size constraint. Entry via limit order at 228.00 provides downside protection.",
        "deconflicting_notes": "Strong expert consensus: FMA and IRM aligned (0.80+ confidence). Technical sentiment positive (QMA 0.80). Applied baseline weighting (70% FMA, 15% IRM, 10% MSPA, 5% QMA)."
      },
      "validation": {
        "qa_status": "PASS",
        "escalation_flag": "PASS",
        "all_constraints_met": true,
        "data_freshness": {
          "sa_output_age_minutes": 12.5,
          "ma_output_age_minutes": 45.0,
          "portfolio_state_age_minutes": 5.0,
          "freshness_status": "FRESH"
        },
        "schema_validation": {
          "sa_output_valid": true,
          "ma_output_valid": true,
          "all_required_fields_present": true
        }
      }
    },
    {
      "meta": {
        "portfolio_orchestrator_version": "v8.0.0-alpha",
        "timestamp": "2025-12-08T14:32:00Z",
        "execution_date": "2025-12-08",
        "batch_id": "PO_20251208_001",
        "instruction_id": "PO_20251208_001_MSFT"
      },
      "trade": {
        "symbol": "MSFT",
        "action": "BLOCKED",
        "quantity_pct": 0.0,
        "order_type": "NONE",
        "conviction_tier": "HIGH",
        "conviction_score": 0.82,
        "strategy_type": "GROWTH"
      },
      "reasoning": {
        "regime": "HOSTILE",
        "risk_regime": "CRISIS",
        "market_regime": "DEFENSIVE",
        "strategy": "GROWTH",
        "base_allocation": 0.05,
        "risk_multiplier": 0.2,
        "regime_multiplier": 0.0,
        "final_allocation": 0.0,
        "exception_applied": false,
        "weighting_context": "CRISIS",
        "constraints_applied": [],
        "rationale": "HIGH conviction (0.82) thesis blocked by hostile market regime (CRISIS risk + DEFENSIVE market). Non-contrarian GROWTH strategy cannot proceed. Regime-gated decision tree enforces protection of capital during crisis conditions. Revisit when market regime improves to NORMAL or ELEVATED.",
        "deconflicting_notes": "All experts elevated risk assessment in crisis context. Applied crisis weighting (40% FMA, 30% IRM, 15% MSPA, 15% QMA). Consensus on elevated risk despite fundamental strength."
      },
      "validation": {
        "qa_status": "PASS",
        "escalation_flag": "PASS",
        "all_constraints_met": true,
        "data_freshness": {
          "sa_output_age_minutes": 15.0,
          "ma_output_age_minutes": 47.0,
          "portfolio_state_age_minutes": 7.0,
          "freshness_status": "FRESH"
        }
      }
    },
    {
      "meta": {
        "portfolio_orchestrator_version": "v8.0.0-alpha",
        "timestamp": "2025-12-08T14:35:00Z",
        "execution_date": "2025-12-08",
        "batch_id": "PO_20251208_001",
        "instruction_id": "PO_20251208_001_TSLA"
      },
      "trade": {
        "symbol": "TSLA",
        "action": "BUY",
        "quantity_pct": 0.006,
        "quantity_dollars": 3000.0,
        "target_price": 280.0,
        "current_price": 250.0,
        "upside_downside": 0.12,
        "order_type": "LIMIT",
        "limit_price": 245.0,
        "time_in_force": "DAY",
        "conviction_tier": "MEDIUM-HIGH",
        "conviction_score": 0.72,
        "strategy_type": "CONTRARIAN",
        "time_horizon": "6_MONTHS"
      },
      "reasoning": {
        "regime": "HOSTILE",
        "risk_regime": "CRISIS",
        "market_regime": "DEFENSIVE",
        "strategy": "CONTRARIAN",
        "base_allocation": 0.03,
        "risk_multiplier": 0.2,
        "regime_multiplier": 0.2,
        "final_allocation": 0.006,
        "exception_applied": true,
        "exception_type": "CONTRARIAN_EXCEPTION",
        "weighting_context": "CRISIS",
        "constraints_applied": [
          "NONE"
        ],
        "rationale": "CONTRARIAN EXCEPTION ACTIVATED: 0.6% pilot deployment in hostile (CRISIS) market regime. MEDIUM-HIGH conviction (0.72) on contrarian valuation thesis despite market panic. Fundamental assets trading at extreme discount (40% below normal valuation). Pilot sizing (0.006%) limits portfolio risk while capturing asymmetric upside opportunity. Use limit order (245.00) for disciplined entry during volatility.",
        "deconflicting_notes": "Expert consensus on overvaluation: FMA (0.75) identifies fundamental strength, IRM (0.85) confirms elevated crisis pricing. MSPA sentiment negative (0.60) reflects panic selling. Applied crisis weighting with emphasis on fundamental-risk deconflicting."
      },
      "validation": {
        "qa_status": "PASS",
        "escalation_flag": "ALERT",
        "escalation_reason": "Contrarian exception applied in CRISIS regime. Verify pilot sizing does not result in >5% portfolio concentration when combined with other contrarian pilots.",
        "all_constraints_met": true,
        "data_freshness": {
          "sa_output_age_minutes": 18.0,
          "ma_output_age_minutes": 50.0,
          "portfolio_state_age_minutes": 10.0,
          "freshness_status": "FRESH"
        }
      }
    }
  ]
}
